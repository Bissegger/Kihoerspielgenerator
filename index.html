<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>ðŸŽ­ KI HÃ–RSPIEL GENERATOR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#0f0f0f;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.app {
  background:#1c1c1c;
  padding:20px;
  border-radius:14px;
  width:100%;
  max-width:540px;
}
h2 { text-align:center; }
.line {
  background:#262626;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
textarea, select, button, input {
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  border:none;
  font-size:15px;
}
button {
  background:#00ccff;
  font-weight:bold;
  cursor:pointer;
}
audio { width:100%; margin-top:15px; }
a {
  display:block;
  margin-top:10px;
  text-align:center;
  color:#00ffaa;
  text-decoration:none;
}
.progress {
  margin-top:15px;
  background:#333;
  border-radius:10px;
  overflow:hidden;
}
.progress-bar {
  height:14px;
  width:0%;
  background:#00ccff;
}
.progress-text {
  text-align:center;
  margin-top:6px;
  font-size:13px;
}
small {
  display:block;
  margin-top:8px;
  opacity:0.6;
  text-align:center;
}
</style>
</head>

<body>
<div class="app">
  <h2>ðŸŽ­ KI HÃ–RSPIEL GENERATOR</h2>

  <input id="apiKey" type="text" placeholder="Dein ElevenLabs API-Key hier einfÃ¼gen">

  <div id="lines"></div>

  <button id="addLineBtn" type="button">âž• Neue Zeile</button>
  <button id="generateBtn" type="button">ðŸŽ¶ HÃ¶rspiel erzeugen</button>

  <div class="progress">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  <div id="progressText" class="progress-text">0.0 %</div>

  <audio id="audio" controls></audio>
  <a id="download">â¬‡ HÃ¶rspiel herunterladen</a>

  <small>HÃ¶rspiel-Modus Â· Fortschritt live</small>
</div>

<script>
function voiceSelectHTML() {
  return `
  <select>
    <option value="EXAVITQu4vr4xnSDxMaL">Adam (mÃ¤nnlich)</option>
    <option value="21m00Tcm4TlvDq8ikWAM">Rachel (weiblich)</option>
    <option value="AZnzlk1XvdvUeBnXmlld">Domi (stark)</option>
    <option value="ErXwobaYiN019PkySvjV">Antoni (weich)</option>
    <option value="MF3mGyEYCl7XYWbV9V6O">Elli (jung)</option>
    <option value="TxGEqnHWrfWFTfGW9XjX">Josh (klar)</option>
  </select>`;
}

function addLine() {
  const div = document.createElement("div");
  div.className = "line";
  div.innerHTML = `${voiceSelectHTML()}<textarea placeholder="Text fÃ¼r diese Rolle..."></textarea>`;
  document.getElementById("lines").appendChild(div);
}

document.getElementById("addLineBtn").addEventListener("click", addLine);
document.getElementById("generateBtn").addEventListener("click", generateHÃ¶rspiel);

// erste Zeile automatisch
addLine();

async function generateHÃ¶rspiel() {
  const apiKey = document.getElementById("apiKey").value.trim();
  if(!apiKey) return alert("sk_d336569cc3360c289ac6c535cb05053a7bb8443f39c9a7e6");

  const lines = document.querySelectorAll(".line");
  if (!lines.length) return alert("Keine Zeilen vorhanden");

  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");

  let audioBuffers = [];
  let step = 0;
  const total = lines.length;

  const updateProgress = () => {
    const percent = ((step / total) * 100).toFixed(1);
    progressBar.style.width = percent + "%";
    progressText.textContent = percent + " %";
  };

  updateProgress();

  for (const line of lines) {
    const text = line.querySelector("textarea").value.trim();
    const voice = line.querySelector("select").value;

    if (!text) { step++; updateProgress(); continue; }

    try {
      const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}`, {
        method: "POST",
        headers: {
          "xi-api-key": apiKey,
          "Content-Type": "application/json",
          "Accept": "audio/mpeg"
        },
        body: JSON.stringify({
          text: text,
          model_id: "eleven_multilingual_v2",
          voice_settings: { stability: 0.2, similarity_boost: 0.9 }
        })
      });

      if(!res.ok){
        const err = await res.text();
        console.error("ElevenLabs Fehler:", err);
        alert("Fehler bei ElevenLabs â€“ siehe Konsole (F12)");
        return;
      }

      audioBuffers.push(await res.arrayBuffer());
      step++;
      updateProgress();
    } catch(e){
      console.error(e);
      alert("Fehler beim Verbinden zu ElevenLabs");
      return;
    }
  }

  const audioContext = new AudioContext();
  const decoded = [];

  for (const buf of audioBuffers) {
    decoded.push(await audioContext.decodeAudioData(buf.slice(0)));
  }

  const length = decoded.reduce((s, b) => s + b.length, 0);
  const output = audioContext.createBuffer(1, length, audioContext.sampleRate);

  let offset = 0;
  decoded.forEach(b => {
    output.getChannelData(0).set(b.getChannelData(0), offset);
    offset += b.length;
  });

  function bufferToWav(buffer) {
    const length = buffer.length * 2 + 44;
    const ab = new ArrayBuffer(length);
    const view = new DataView(ab);
    let pos = 0;

    const write = s => { for (let i=0;i<s.length;i++) view.setUint8(pos++, s.charCodeAt(i)); };

    write("RIFF"); view.setUint32(pos, length-8, true); pos+=4;
    write("WAVEfmt "); view.setUint32(pos,16,true); pos+=4;
    view.setUint16(pos,1,true); pos+=2;
    view.setUint16(pos,1,true); pos+=2;
    view.setUint32(pos,buffer.sampleRate,true); pos+=4;
    view.setUint32(pos,buffer.sampleRate*2,true); pos+=4;
    view.setUint16(pos,2,true); pos+=2;
    view.setUint16(pos,16,true); pos+=2;
    write("data"); view.setUint32(pos,buffer.length*2,true); pos+=4;

    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++,pos+=2) {
      const s = Math.max(-1, Math.min(1, data[i]));
      view.setInt16(pos, s < 0 ? s*0x8000 : s*0x7fff, true);
    }
    return new Blob([ab], { type:"audio/wav" });
  }

  const wav = bufferToWav(output);
  const url = URL.createObjectURL(wav);

  const audio = document.getElementById("audio");
  const download = document.getElementById("download");

  audio.src = url;
  download.href = url;
  download.download = "hoerspiel.wav";
  audio.play();

  progressBar.style.width = "100%";
  progressText.textContent = "100.0 %";
}
</script>
</body>
</html>
